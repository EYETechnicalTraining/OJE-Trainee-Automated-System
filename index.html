<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OJE Attendance System</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f9; margin:0; padding:20px; display:flex; justify-content:center; }
  .container { max-width: 450px; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  h2 { color: #333; text-align:center; }
  input[type=text], input[type=email], input[type=password], input[type=number] {
    width: 100%; padding: 10px; margin: 10px 0; border:1px solid #ccc; border-radius: 4px; box-sizing: border-box;
  }
  button {
    background-color: #4caf50; color: white; border:none; padding: 12px; width: 100%; font-size: 16px; cursor:pointer; border-radius: 5px;
  }
  button:disabled { background: #a5d6a7; cursor: not-allowed; }
  .hidden { display: none; }
  .message { margin: 10px 0; padding: 10px; border-radius: 4px; }
  .error { background: #f8d7da; color: #721c24; }
  .success { background: #d4edda; color: #155724; }
  .link-btn {
    background:none; border:none; color:#007bff; text-decoration: underline; cursor:pointer; margin-top: 10px; padding:0;
  }
</style>
</head>
<body>

<div class="container">

  <!-- REGISTRATION -->
  <div id="registration-section">
    <h2>Register</h2>
    <input type="text" id="reg-student-id" placeholder="Student ID" required />
    <input type="text" id="reg-student-name" placeholder="Full Name" required />
    <input type="email" id="reg-student-email" placeholder="Email" required />
    <input type="password" id="reg-password" placeholder="Password" required />
    <input type="password" id="reg-password-confirm" placeholder="Confirm Password" required />
    
    <label><input type="checkbox" id="show-password"> Show Password</label>

    <button id="btn-send-otp" disabled>Send OTP</button>
    
    <p id="reg-message" class="message hidden"></p>
  </div>

  <!-- OTP VERIFICATION -->
  <div id="otp-section" class="hidden">
    <h2>Verify OTP</h2>
    <p>OTP sent to your email. Please enter it below:</p>
    <input type="number" id="otp-input" placeholder="Enter OTP" />
    <button id="btn-verify-otp">Verify OTP</button>
    <p id="otp-message" class="message hidden"></p>
    <button class="link-btn" id="btn-resend-otp">Resend OTP</button>
  </div>

  <!-- LOGIN -->
  <div id="login-section" class="hidden">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email" required />
    <input type="password" id="login-password" placeholder="Password" required />
    <button id="btn-login">Login</button>
    <p id="login-message" class="message hidden"></p>
    <button class="link-btn" id="btn-to-register">Register Instead</button>
  </div>

  <!-- ATTENDANCE -->
  <div id="attendance-section" class="hidden">
    <h2>Welcome, <span id="attendee-name"></span></h2>
    <p><strong>Student ID:</strong> <span id="attendee-id"></span></p>
    <p><strong>Email:</strong> <span id="attendee-email"></span></p>
    <p><strong>Current Date & Time:</strong> <span id="current-datetime"></span></p>
    <button id="btn-mark-attendance">Mark Attendance</button>
    <p id="attendance-message" class="message hidden"></p>
    <button class="link-btn" id="btn-logout">Logout</button>
  </div>

</div>

<script>
// ==== Flow URLs ==== (Replace with your actual URLs)
const validateStudentExistenceUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/d2fd8d79a22c4ea5ada0c512eaac3257/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=QN_nV-ZLNHyUGxSBgC5sM2VSp5o1_Uqohoevm5bKRXk";
const sendOtpUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/c3340d8bb42a415cb1932224e0625722/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KuDuKpT56nk7IaIXYg9ywDCitNF4E96swrAeXJ00h4Q";
const verifyOtpUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/ad9257dcff9b4f709459576e558ad7a6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jrQnda9Jr_Opg_c-QaLoSSC1ZInoi5d1uvO7J7B-4wQ";
const createRegistrationUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/da543851a92f4e6d81aab7056650b8dd/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=0s7uFvz6dPm1zfJIWTnpq4RzzuaJXNgx6AgHFZxegrg";
const checkLoginCredentialsUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/61a88948acdb477ebc866ac5ea518906/triggers/manual/paths/invoke?api-version=1";
const attendanceFlowUrl = "https://defaultc90d8d828a61421b9f8c35ab8bc5bc.9c.environment.api.powerplatform.com/powerautomate/automations/direct/workflows/57c92940051d45378ca150defaf99c01/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=uJxqo2979DyhYqKSo5GsqlVwWrNYq_Tn9LLDy9eFvcg";

// === Utility functions ===
function showSection(sectionId) {
  ['registration-section', 'otp-section', 'login-section', 'attendance-section'].forEach(id => {
    document.getElementById(id).style.display = (id === sectionId) ? 'block' : 'none';
  });
  clearMessages();
}

function clearMessages() {
  ['reg-message', 'otp-message', 'login-message', 'attendance-message'].forEach(id => {
    const el = document.getElementById(id);
    el.className = 'message hidden';
    el.textContent = '';
  });
}

function showMessage(id, text, isError = true) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = isError ? 'message error' : 'message success';
  el.classList.remove('hidden');
}

function getCurrentUAETimeISO() {
  const now = new Date();
  // UAE is UTC+4
  const uaeTime = new Date(now.getTime() + 4 * 60 * 60 * 1000);
  return uaeTime.toISOString().slice(0,19); // YYYY-MM-DDTHH:mm:ss
}

// === Password show/hide toggle ===
document.getElementById('show-password').addEventListener('change', e => {
  const pass = document.getElementById('reg-password');
  const conf = document.getElementById('reg-password-confirm');
  if(e.target.checked) {
    pass.type = 'text';
    conf.type = 'text';
  } else {
    pass.type = 'password';
    conf.type = 'password';
  }
});

// Enable Send OTP button only if inputs are filled and passwords match
function validateRegistrationInputs() {
  const id = document.getElementById('reg-student-id').value.trim();
  const name = document.getElementById('reg-student-name').value.trim();
  const email = document.getElementById('reg-student-email').value.trim();
  const pass = document.getElementById('reg-password').value;
  const conf = document.getElementById('reg-password-confirm').value;

  const btn = document.getElementById('btn-send-otp');
  if(id && name && email && pass && conf && pass === conf) {
    btn.disabled = false;
    clearMessages();
  } else {
    btn.disabled = true;
    if(pass !== conf && pass && conf) {
      showMessage('reg-message', 'Passwords do not match.');
    } else {
      document.getElementById('reg-message').classList.add('hidden');
    }
  }
}

['reg-student-id','reg-student-name','reg-student-email','reg-password','reg-password-confirm'].forEach(id => {
  document.getElementById(id).addEventListener('input', validateRegistrationInputs);
});

// === Registration: Send OTP ===
document.getElementById('btn-send-otp').addEventListener('click', async () => {
  clearMessages();
  const id = document.getElementById('reg-student-id').value.trim();
  const name = document.getElementById('reg-student-name').value.trim();
  const email = document.getElementById('reg-student-email').value.trim();
  const password = document.getElementById('reg-password').value;

  showMessage('reg-message', 'Validating user...', false);

  try {
    // Validate student existence in OJE TRAINEE MASTER DATA
    const validateResponse = await fetch(validateStudentExistenceUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({StudentID: id, FullName: name, Email: email})
    });
    if(!validateResponse.ok) throw new Error('Validation service error');
    const validateResult = await validateResponse.json();

    if(!validateResult.valid) {
      showMessage('reg-message', validateResult.message || 'Student not found in master data.');
      return;
    }

    // Save entered data temporarily in sessionStorage for OTP step
    sessionStorage.setItem('regTempData', JSON.stringify({id, name, email, password}));

    // Call SendOTP flow with Email
    const sendOtpResponse = await fetch(sendOtpUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({Email: email})
    });
    if(!sendOtpResponse.ok) throw new Error('Failed to send OTP');

    showMessage('otp-message', 'OTP sent! Please check your email.', false);

    // Move to OTP section
    showSection('otp-section');

  } catch (err) {
    showMessage('reg-message', 'Error: ' + err.message);
  }
});

// === OTP Verification ===
document.getElementById('btn-verify-otp').addEventListener('click', async () => {
  clearMessages();
  const otp = document.getElementById('otp-input').value.trim();
  if(!otp) {
    showMessage('otp-message', 'Please enter the OTP.');
    return;
  }

  const tempDataStr = sessionStorage.getItem('regTempData');
  if(!tempDataStr) {
    showMessage('otp-message', 'Session expired. Please register again.');
    showSection('registration-section');
    return;
  }
  const tempData = JSON.parse(tempDataStr);

  try {
    const verifyResponse = await fetch(verifyOtpUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({Email: tempData.email, OTP: otp})
    });
    if(!verifyResponse.ok) throw new Error('OTP verification failed');

    const verifyResult = await verifyResponse.json();

    if(!verifyResult.valid) {
      showMessage('otp-message', verifyResult.message || 'OTP did not match or expired.');
      return;
    }

    // OTP verified - create registration in SharePoint
    showMessage('otp-message', 'OTP verified! Creating registration...', false);

    const createResponse = await fetch(createRegistrationUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        StudentID: tempData.id,
        FullName: tempData.name,
        Email: tempData.email,
        Password: tempData.password,
        Registered: true
      })
    });
    if(!createResponse.ok) throw new Error('Failed to create registration');

    showMessage('otp-message', 'Registration successful! Please login.', false);
    sessionStorage.removeItem('regTempData');

    // Show login section after short delay
    setTimeout(() => {
      showSection('login-section');
      clearRegistrationForm();
    }, 1500);

  } catch (err) {
    showMessage('otp-message', 'Error: ' + err.message);
  }
});

// Resend OTP button
document.getElementById('btn-resend-otp').addEventListener('click', async () => {
  clearMessages();
  const tempDataStr = sessionStorage.getItem('regTempData');
  if(!tempDataStr) {
    showMessage('otp-message', 'Session expired. Please register again.');
    showSection('registration-section');
    return;
  }
  const tempData = JSON.parse(tempDataStr);
  try {
    const sendOtpResponse = await fetch(sendOtpUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({Email: tempData.email})
    });
    if(!sendOtpResponse.ok) throw new Error('Failed to send OTP');
    showMessage('otp-message', 'OTP resent! Please check your email.', false);
  } catch(err) {
    showMessage('otp-message', 'Error: ' + err.message);
  }
});

// === Clear registration form inputs ===
function clearRegistrationForm() {
  ['reg-student-id','reg-student-name','reg-student-email','reg-password','reg-password-confirm'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('btn-send-otp').disabled = true;
  document.getElementById('reg-message').classList.add('hidden');
}

// === Login ===
document.getElementById('btn-login').addEventListener('click', async () => {
  clearMessages();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;

  if(!email || !password) {
    showMessage('login-message', 'Please enter email and password.');
    return;
  }

  try {
    const loginResponse = await fetch(checkLoginCredentialsUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({Email: email, Password: password})
    });

    if(!loginResponse.ok) throw new Error('Login failed');
    const loginResult = await loginResponse.json();

    if(!loginResult.valid) {
      showMessage('login-message', loginResult.message || 'Invalid credentials or not registered.');
      return;
    }

    // Save login email in sessionStorage
    sessionStorage.setItem('loggedInEmail', email);
    sessionStorage.setItem('loggedInName', loginResult.name || '');
    sessionStorage.setItem('loggedInStudentID', loginResult.studentID || '');

    showSection('attendance-section');
    loadAttendanceDetails();

  } catch (err) {
    showMessage('login-message', 'Error: ' + err.message);
  }
});

// Show login form when user clicks Register Instead
document.getElementById('btn-to-register').addEventListener('click', () => {
  showSection('registration-section');
});

// === Load Attendance Details ===
function loadAttendanceDetails() {
  const email = sessionStorage.getItem('loggedInEmail');
  const name = sessionStorage.getItem('loggedInName');
  const studentID = sessionStorage.getItem('loggedInStudentID');

  if(!email) {
    showSection('login-section');
    return;
  }

  document.getElementById('attendee-name').textContent = name || '';
  document.getElementById('attendee-id').textContent = studentID || '';
  document.getElementById('attendee-email').textContent = email;
  updateCurrentDateTime();
}

function updateCurrentDateTime() {
  const now = new Date();
  const uaeTime = new Date(now.getTime() + 4*60*60*1000);
  document.getElementById('current-datetime').textContent = uaeTime.toLocaleString();
}

setInterval(updateCurrentDateTime, 1000);

// === Mark Attendance ===
document.getElementById('btn-mark-attendance').addEventListener('click', async () => {
  clearMessages();
  const email = sessionStorage.getItem('loggedInEmail');
  const studentID = sessionStorage.getItem('loggedInStudentID');
  const name = sessionStorage.getItem('loggedInName');

  if(!email) {
    showMessage('attendance-message', 'You are not logged in.');
    showSection('login-section');
    return;
  }

  try {
    // Call attendance flow (pass email + timestamp)
    const attendanceResponse = await fetch(attendanceFlowUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        Email: email,
        StudentID: studentID,
        FullName: name,
        AttendanceTime: new Date().toISOString()
      })
    });

    if(!attendanceResponse.ok) throw new Error('Failed to mark attendance');
    const attendanceResult = await attendanceResponse.json();

    if(attendanceResult.success) {
      showMessage('attendance-message', 'Attendance marked successfully!', false);
    } else {
      showMessage('attendance-message', attendanceResult.message || 'Failed to mark attendance.');
    }
  } catch(err) {
    showMessage('attendance-message', 'Error: ' + err.message);
  }
});

// === Logout ===
document.getElementById('btn-logout').addEventListener('click', () => {
  sessionStorage.clear();
  showSection('login-section');
});

// === On page load ===
window.onload = () => {
  if(sessionStorage.getItem('loggedInEmail')) {
    showSection('attendance-section');
    loadAttendanceDetails();
  } else {
    showSection('registration-section');
  }
};
</script>

</body>
</html>
